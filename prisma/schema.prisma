generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ParentUser {
  id                   String         @id @default(cuid())
  clerkUserId          String?        @unique  // Phase 3B: Made optional for migration
  supabaseUserId       String?        @unique @db.Uuid  // Phase 3B: Supabase Auth ID
  dob                  DateTime
  consentAt            DateTime
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  name                 String         @default("") @db.VarChar(100)
  isDeleted            Boolean        @default(false)
  deletedAt            DateTime?      @db.Timestamptz(6)
  subscriptionStatus   String?
  subscriptionProvider String?
  subscriptionId       String?
  currentPeriodEnd     DateTime?      @db.Timestamptz(6)
  trialEndsAt          DateTime?      @db.Timestamptz(6)
  cancelAt             DateTime?      @db.Timestamptz(6)
  canceledAt           DateTime?      @db.Timestamptz(6)
  dobDate              DateTime?      @db.Date
  AuditLog             AuditLog[]
  children             ChildProfile[]

  @@index([supabaseUserId])  // Phase 3B: Index for Supabase auth lookups
}

model ChildProfile {
  id             String     @id @default(cuid())
  parentId       String
  name           String
  age            Int
  avatar         String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  currentStreak  Int        @default(0)
  longestStreak  Int        @default(0)
  lastPracticeAt DateTime?  // For streak logic  
  isDeleted      Boolean    @default(false)
  deletedAt      DateTime?  @db.Timestamptz(6)
  // Phase 2: XP and gamification
  totalXp        Int        @default(0)
  level          Int        @default(1)
  attempts       Attempt[]
  parent         ParentUser @relation(fields: [parentId], references: [id], onDelete: Cascade)
  mastery        Mastery[]
  sessions       Session[]
  achievements   ChildAchievement[]
}

model Surah {
  id        Int      @id
  name      String
  nameEn    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  verses    Verse[]
}

model Verse {
  id              Int     @id
  surahId         Int
  verseNumber     Int
  textArabic      String
  translation     String
  transliteration String
  audioUrl        String?
  surah           Surah   @relation(fields: [surahId], references: [id], onDelete: Cascade)
  words           Word[]

  @@index([surahId, verseNumber])
}

model Word {
  id              Int       @id
  verseId         Int
  position        Int
  textArabic      String
  translation     String
  transliteration String
  audioUrl        String?
  isSeparator     Boolean   @default(false)
  attempts        Attempt[]
  mastery         Mastery[]
  verse           Verse     @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@index([verseId, position])
}

model Session {
  id                String        @id @default(cuid())
  childId           String
  type              SessionType
  status            SessionStatus @default(ACTIVE)
  surahId           Int?
  startVerseId      Int?
  endVerseId        Int?
  maxAttempts       Int?
  requiredSuccesses Int?
  startedAt         DateTime      @default(now()) @db.Timestamptz(6)
  completedAt       DateTime?     @db.Timestamptz(6)
  createdAt         DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime      @default(now()) @updatedAt @db.Timestamptz(6)
  attempts          Attempt[]
  child             ChildProfile  @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId, status])
  @@index([childId, createdAt])
}

model Attempt {
  id              String       @id @default(cuid())
  childId         String
  wordId          Int
  accuracy        Float
  createdAt       DateTime     @default(now())
  deviceAttemptId String       @unique
  sessionId       String?
  attemptNumber   Int          @default(1)
  child           ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  session         Session?     @relation(fields: [sessionId], references: [id])
  word            Word         @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([childId, sessionId])
  @@index([childId, createdAt])
  @@index([childId, accuracy]) // Phase 3: For analytics queries
}

model Mastery {
  id            String       @id @default(cuid())
  childId       String
  wordId        Int
  status        String       @db.VarChar(20)
  streak        Int          @default(0)
  lastAttemptAt DateTime
  child         ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  word          Word         @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([childId, wordId])
  @@index([childId, status])
  @@index([wordId, status]) // Phase 3: For word-level mastery lookups
}

model AuditLog {
  id         String      @id @default(cuid())
  parentId   String?
  action     String      @db.VarChar(50)
  entity     String?
  entityId   String?
  details    Json?
  ipAddress  String?     @db.VarChar(45)
  userAgent  String?     @db.VarChar(500)
  createdAt  DateTime    @default(now()) @db.Timestamptz(6)
  ParentUser ParentUser? @relation(fields: [parentId], references: [id])

  @@index([parentId, createdAt])
  @@index([action, createdAt])
}

enum SessionType {
  VERSE_LESSON
  MULTI_VERSE_QUIZ
  SURAH_TEST
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  FAILED
}

// Phase 2: Gamification - Achievement definitions
model Achievement {
  id          String             @id @default(cuid())
  name        String             @unique // e.g., "FIRST_VERSE", "PERFECT_RECITATION"
  displayName String             // Human-readable: "First Verse"
  description String             // "Complete your first verse"
  iconToken   String             // e.g., "BADGE_STAR", "BADGE_FIRE"
  xpReward    Int                @default(0)
  createdAt   DateTime           @default(now())
  children    ChildAchievement[]
}

// Phase 2: Gamification - Child's earned achievements
model ChildAchievement {
  id            String       @id @default(cuid())
  childId       String
  achievementId String
  earnedAt      DateTime     @default(now())
  child         ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  achievement   Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([childId, achievementId])
  @@index([childId, earnedAt])
}
